{% extends "admin_pages/base.html" %}
{% load static %}

{% block title %}Add Project | Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
.field-error { display:none; font-size:0.875rem; margin-top:0.25rem; color:#dc3545; }
.field-error-border { border-color:#dc3545 !important; box-shadow:0 0 0 2px rgba(220,53,69,0.1) !important; }
.ck.ck-editor__top.ck-reset_all { position:relative !important; top:auto !important; z-index:10 !important; }
.ck.ck-sticky-panel .ck-sticky-panel__content { position:relative !important; top:auto !important; }
.ck.ck-toolbar { position:relative !important; top:auto !important; }
.ck-editor { position:relative !important; overflow:visible !important; }
.ck-editor__editable_inline { min-height:200px; height:auto !important; overflow-y:visible !important; }
.ck-sticky-panel { position:static !important; }
.ck.ck-editor { z-index:1 !important; }
.ck.ck-balloon-panel { z-index:1000 !important; }
.ck-editor__editable ul, .ck-editor__editable ol { padding-left:40px !important; }
.ck-editor__editable ul { list-style-type:disc !important; }
.ck-editor__editable ol { list-style-type:decimal !important; }
.ck-editor__editable li { display:list-item !important; }

*, *::before, *::after { box-sizing:border-box; }
html, body { max-width:100%; overflow-x:hidden; }
.form-wrapper { max-width:900px; width:100%; margin:0 auto; padding:0 1rem; }
input, textarea, select, .form-control { max-width:100%; width:100%; }
.modern-input { border:1px solid #d1d5db; border-radius:8px; padding:0.85rem 1rem; font-size:1rem; background:#fff; transition:all 0.3s ease; }
.modern-input:focus { border-color:#4f46e5; box-shadow:0 0 0 3px rgba(79,70,229,0.08); }
.dashboard__form__button { display:flex; flex-wrap:wrap; gap:0.75rem; }
.dashboard__form__button .default__button { background:#4f46e5; color:#fff; padding:0.85rem 1.6rem; border-radius:8px; font-weight:500; border:none; transition:background 0.3s; }
.dashboard__form__button .default__button:hover { background:#4338ca; }
.image-preview { max-width:300px; height:200px; border:2px dashed #d1d5db; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
.image-preview img { max-width:100%; max-height:100%; object-fit:cover; }
.dashboard__section__title { border-bottom:1px solid #eaeaea; padding-bottom:1rem; margin-bottom:2rem; }
@media (max-width:992px) { .dashboard__form__button { flex-direction:column; align-items:stretch; } .image-preview { width:100%; } }
</style>
{% endblock %}

{% block content %}
<div class="dashboard sp_bottom_100">
    <div class="container-fluid full__width__padding">
        <div class="row">
            <div class="col-xl-9 col-lg-9 col-md-12 col-sm-12">
                <div class="dashboard__section__title">
                    <h4 class="mb-0">Add Project</h4>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <form method="post" enctype="multipart/form-data" class="form-wrapper" novalidate>
                            {% csrf_token %}
                            <div class="row">

                                <!-- Title -->
                                <div class="col-12 mb-4">
                                    <label for="title" class="form-label">Project Title <span class="text-danger">*</span></label>
                                    <input type="text" name="title" id="title" class="form-control modern-input" placeholder="Enter project title" required>
                                </div>

                                <!-- Service Category -->
                                <div class="col-12 mb-4">
                                    <label for="service_category" class="form-label">Service Category <span class="text-danger">*</span></label>
                                    <select name="service_category" id="service_category" class="form-select modern-input" required>
                                        <option value="">-- Select Category --</option>
                                        {% for service in all_services %}
                                        <option value="{{ service.id }}">{{ service.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Location -->
                                <div class="col-12 mb-4">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" name="location" id="location" class="form-control modern-input" placeholder="e.g. Dubai Hills">
                                </div>

                                <!-- Project Image -->
                                <div class="col-12 mb-4">
                                    <label for="image" class="form-label">Project Image <span class="text-danger">*</span></label>
                                    <input type="file" name="image" id="image" class="form-control modern-input" accept="image/*" required>
                                    <div class="form-text">Recommended size: 800x600px. Max: 2MB</div>
                                    <div id="imagePreview" class="image-preview mt-2" style="display:none;"></div>
                                </div>

                                <!-- Description -->
                                <div class="col-12 mb-4">
                                    <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                                    <textarea name="description" id="description" class="form-control modern-input uni-description" rows="8" placeholder="Describe the work done in this project..." required></textarea>
                                </div>

                                <!-- Buttons -->
                                <div class="col-12 mt-4">
                                    <div class="dashboard__form__button">
                                        <button type="submit" class="default__button">Add Project</button>
                                        <a href="{% url 'project_list' %}" class="default__button" style="background:#6c757d;">Cancel</a>
                                    </div>
                                </div>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    let descEditor;

    ClassicEditor.create(document.querySelector('#description'), {
        toolbar: ['heading','|','bold','italic','link','bulletedList','numberedList','|','blockQuote','undo','redo','imageUpload']
    }).then(editor => {
        descEditor = editor;
        editor.plugins.get('FileRepository').createUploadAdapter = loader => ({
            upload: () => loader.file.then(file => new Promise((res, rej) => {
                const r = new FileReader();
                r.onload = () => res({ default: r.result });
                r.onerror = e => rej(e);
                r.readAsDataURL(file);
            })),
            abort: () => {}
        });
    }).catch(console.error);

    // Image Preview
    document.getElementById('image').addEventListener('change', function () {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { preview.style.display = 'flex'; preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`; };
            reader.readAsDataURL(this.files[0]);
        } else preview.style.display = 'none';
    });

    // Validation
    const fields = {
        title: { el: document.getElementById('title'), validate: v => !v.trim() ? 'Project title is required.' : null },
        service_category: { el: document.getElementById('service_category'), validate: v => !v ? 'Please select a service category.' : null },
        image: { el: document.getElementById('image'), isFile: true, validate: v => !v ? 'Project image is required.' : null },
        description: { el: document.getElementById('description'), isEditor: true, getEditor: () => descEditor, validate: v => !v.trim() ? 'Description is required.' : null }
    };

    Object.entries(fields).forEach(([key, f]) => {
        const err = document.createElement('div');
        err.classList.add('text-danger', 'mt-1');
        err.style.fontSize = '0.875rem';
        f.el.insertAdjacentElement('afterend', err);
        f.errEl = err;
    });

    function validateField(key) {
        const f = fields[key];
        let val;
        if (f.isFile) val = f.el.files[0] || null;
        else if (f.isEditor && f.getEditor()) val = f.getEditor().getData().replace(/<[^>]*>/g, '').trim();
        else val = f.el.value;
        const err = f.validate(val);
        f.errEl.textContent = err || '';
        f.errEl.style.display = err ? 'block' : 'none';
        f.el.classList.toggle('field-error-border', !!err);
        return !err;
    }

    function validateAll() { return Object.keys(fields).every(validateField); }

    Object.keys(fields).forEach(key => {
        const f = fields[key];
        f.el.addEventListener('blur', () => validateField(key));
        f.el.addEventListener('input', () => { if (f.errEl.textContent) validateField(key); });
        if (f.isFile) f.el.addEventListener('change', () => validateField(key));
    });

    document.querySelector('form').addEventListener('submit', function (e) {
        if (!validateAll()) {
            e.preventDefault();
            const first = Object.keys(fields).find(k => fields[k].errEl.textContent);
            if (first) fields[first].el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
});
</script>
{% endblock %}